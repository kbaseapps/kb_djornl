# kb_djornl

[![Build Status][build-image]][build-url]

This [KBase](https://kbase.us) module is a wrapper and visualization for RWR
tools which use the random walk with restart method on multiplex coexpression
networks representing genes (nodes) and distinct lines of evidence (edges)
facilitating the rapid determination of the functional context of genes of
interest. This generated by the [KBase Software Development Kit (SDK)][kb-sdk].

You will need to have the SDK installed to use this module. [Learn more about
the SDK and how to use it][kb-sdk-docs].

You can also learn more about the apps implemented in this module from its
[catalog page][kb_djornl-catalog] or its [spec file](kb_djornl.spec).

[build-image]: https://github.com/kbaseapps/kb_djornl/actions/workflows/action.yaml/badge.svg
[build-url]: https://github.com/kbaseapps/kb_djornl/actions/workflows/action.yaml
[kb-sdk]: https://github.com/kbase/kb_sdk
[kb-sdk-docs]: https://kbase.github.io/kb_sdk_docs/
[kb_djornl-catalog]: https://narrative.kbase.us/#catalog/modules/kb_djornl

### RWRtools CV

This app wraps the RWR Cross Validation tool which performs k-fold cross
validation on a single gene set, finding the RWR rank of the left-out genes.
One can choose either leave-one-out to leave only one gene from the gene set
out and find its rank, or run k-fold cross-validation for a specified value
of k.

### RWRtools LOE

This app wraps the RWR Lines of Evidence tool which has two possible functions.  
Given one geneset of seeds, rankings for all other genes in the network will 
be returned.  Given a second geneset, ranking for just the genes in that geneset 
will be returned.  This can be used to build multiple lines of evidence from 
the various input networks to relate the two gene sets.

# Tests

Run
```bash
kb-sdk test
```

Add your KBase developer token to `test_local/test.cfg` and run:

```bash
kb-sdk test
```

This may take a long time, the build action is runs in approximately 30 minutes
from scratch. Subsequent runs should be faster for two reasons. Firstly, the
initial Docker build takes some time, primarily compiling the conda
environment. This needs to be done only once since Docker will cache the
results. Secondly, the `exascale_repo` data source is validated and this can
take around 10 minutes on its own. Since this is loaded as refdata, this also
only happens when the refdata is updated. For instructions on how to update the
refdata, see the [Howsto](#howsto) section below.

# Contributing

Note: By default the module image uses Python 3.7.0, and these instructions are
tested with this version, but will probably work with any higher version.
Follow the following instructions to configure your development environment.

0. Install prerequisites:
    - kb-sdk
    - node >= 14.15.4
    - python >= 3.7.0
1. Make a virtual environment and activate it.
```
python -m venv $VENV
source $VENV/bin/activate
```
2. Install Python requirements:
```
pip install \
    --extra-index-url https://pypi.anaconda.org/kbase/simple \
    -r requirements.txt
```
2. Run `kb-sdk test`. This will generate a sample report.
3. Install the Javascript requirements:
```
npm install
```
4. Start a server to serve the sample report:
```
npm run serve
```
By default this server listens on port 8080, but you can specify any port with
the following invocation:
```
npm run serve -- --port $PORT
```
5. (Optional) Enable the pre-commit hooks:
```
cp scripts/pre-commit.sh .git/hooks/pre-commit
```

# Howsto

The instructions in this section refer to the following external repositories:
- Data: [`exascale_data`][repo-exascale]
- Relation Engine (RE): [`relation_engine`][repo-re]
- The [`RWRtools`][repo-rwrtools] repository.

[repo-exascale]: https://github.com/kbase/exascale_data
[repo-re]: https://github.com/kbase/relation_engine
[repo-rwrtools]: https://github.com/dkainer/RWRtools

## Test a new version of the app

1. Register the app in the desired environment.
2. Update app cells in narratives with the new version of the app.
3. Create an app cell representing a call guaranteed to contain some of the new
    data to confirm that it has been updated correctly.

## Update layer

This section specifically refers how to add, edit or replace edges in an
    existing network.
1. Update the `exascale_data` repo with the layer in question, this should
    ultimately be an update to a single file in the `prerelease/edge_data`
    folder.
2. Commit this change to the repository in GitHub.
3. Modify the `git clone` command for `exascale_data` in
    `scripts/refdata-load.sh` to point to the correct branch or commit.
4. Bump the `data-version` semantic version value in `kbase.yaml`. This will
    ensure that the refdata is loaded in the next step.
5. Commit these changes to the `kb_djornl` repository in GitHub.
6. Test this new version of the app.

## Add Layer

This section specifically refers how to add a single new network represented by
a TSV file with four columns (`node1`, `node2`, `score`, `edge_type`) and a
header row. It also assumes that this network introduces a single new
`edge_type`.

1. Update the `exascale_data` repo.
    1. Add the layer in question, this should ultimately be an addition of a
        single file to the `prerelease/edge_data` folder.
    2. Update the `prerelease/manifest.yaml` file with appropriate metadata for
        this layer.
    3. Commit these changes to the repository in GitHub.
2. Update the RE repo.
    1. Modify the `spec/datasets/djornl/edge_type.yaml` file ensuring that the
        `const` key's value matches the edge type in the network (edge) file.
    2. Commit these changes to the repository in GitHub.
3. Update the `kb_djornl` app:
    1. Modify `edgeMetadata` in the `report/app/style.js` file. The key should
        be the desired `edge_type` and the value should contain the other
        appropriate metadata.
    2. Modify the `git clone` command for `exascale_data` and `relation_engine`
        in `scripts/refdata-load.sh` to point to the correct branch or commit
        for the changes above.
    3. Bump the `data-version` semantic version value in `kbase.yaml`. This
        will ensure that the refdata is loaded in the next step.
    4. Commit these changes to the repository in GitHub.
4. Test this new version of the app.

## Update RWRtools

The RWRtools are currently contained in a private repository. To work around
this, we create a blobstore object containing the latest version of the
repository and download that at refdata update time.

The following assumes:
- No new dependencies have been added to `RWRtools`.
    - If the dependencies have changed then the Conda environment within the
        container will have to be adjusted. See
        [`data/rwrtools.yml`](data/rwrtools.yml).
- No change in options taken by `RWRtools` scripts.
    - If options change then the calls to `RWRtools` from the app will need to
        be updated.

1. Create the `RWRtools` blobstore object and get its blobstore object URL,
    referred to here as `node_url`. See more detailed instructions below.
    1. Make a shallow clone of the `RWRtools` repository's `dev` branch.
    2. Run a `DataFileUtil` container to package and upload the code.
    3. Once in the `DataFileUtil` container start an ipython session.
    4. Use DataFileUtil to upload the repository. You should now have the
        `node_url`.
2. Copy the `node_url` into the `curl` in
    [`scripts/refdata-load.sh`](scripts/refdata-load.sh)
3. Remove the local `__READY__` file.
```rm test_local/refdata/__READY__```
4. Run `kb-sdk test` to reload the refdata.
5. If all is working as planned then update the data version in `kbase.yml`,
    commit these changes and reregister the app.
6. Test this new version of the app.

### Create `RWRtools` blobstore object and get its `node_url`
1. Clone `DataFileUtil` and change directory into it
```bash
git clone git@github.com:kbaseapps/DataFileUtil.git
cd DataFileUtil
```
2. Make a shallow clone of the `RWRtools` repository's `dev` branch.
```bash
git clone --branch dev --depth 1 git@github.com:dkainer/RWRtools.git RWRtools.shallow
```
3. Run `kb-sdk test` to build the DataFileUtil image. You may have to put your
token in `test_local/test.cfg` and run `kb-sdk test` again if this is the first
time building the image.
4. Run a `DataFileUtil` container to package and upload the code.
```bash
docker run -it test/datafileutil bash
```
5. Once in the `DataFileUtil` container run the following commands
```bash
cd lib
ipython
```
6. In the ipython session run the commands below. Set the token to a valid
    token for the environment, here `appdev` is used as an example.
```python
from DataFileUtil.DataFileUtilImpl import DataFileUtil
token = your_token_here
env = 'appdev'
dfu = DataFileUtil({
    'kbase-endpoint': f'https://{env}.kbase.us/services',
    'handle-service-url': f'https://{env}.kbase.us/services/handle_service',
    'pigz_n_processes': 1,
    'pigz_compression_level': 1,
    'scratch': '.',
    'shock-url': f'https://{env}.kbase.us/services/shock-api',
    'workspace-url': f'https://{env}.kbase.us/services/ws',
})
node = dfu.file_to_shock(
    {'token': token},
    {
        'file_path': '/kb/module/RWRtools.shallow/',
        'make_handle': 1,
        'pack': 'targz'
    }
)
node_url = f"""{dfu.shock_url}/node/{node[0]["shock_id"]}?download_raw"""
print(f'node_url: {node_url}')
```

## Add new dependencies for `RWRtools`

1. Save the `RWRtools` [environment.yml][rwrtools-environment] file as
    [`data/rwrtools.yml`](data/rwrtools.yml).
2. Follow instructions above to update `RWRtools`.

[rwrtools-environment]: https://github.com/dkainer/RWRtools/blob/dev/environment.yml
